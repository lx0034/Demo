/**
 * 打包阶段插件接口
 * @param  {Object} ret      一个包含处理后源码的结构
 * @param  {Object} conf     一般不需要关心，自动打包配置文件
 * @param  {Object} settings 插件配置属性
 * @param  {Object} opt      命令行参数
 * @return {undefined}          
 */
var base64 =  fis.util.read(__dirname + '/lib/skull-icon.png');
base64 = fis.util.base64(base64);
 var skullIconBase64 = 'data:' + fis.util.getMimeType('png') + ';base64,' +base64
module.exports = function (ret, conf, settings, opt) {
    // ret.src 所有的源码，结构是 {'<subpath>': <File 对象>}
    // ret.ids 所有源码列表，结构是 {'<id>': <File 对象>}
    // ret.map 如果是 spriter、postpackager 这时候已经能得到打包结果了，
    //         可以修改静态资源列表或者其他
    var config =fis.util.merge({
        include: [],
        exclude: [],
        urlReg: '\:\/\/test',
    }, settings);
    var include = config.include;
    var deployConfig = fis.config.get('deploy');
    //不进行delpy的不加提示，include 匹配的除外
    if( (deployConfig[opt.dest] === undefined
        || deployConfig[opt.dest][0].receiver === undefined 
        &&  include.indexOf(opt.dest) === -1)
     ){
        return;
    }

    if( config.exclude.indexOf(opt.dest) !== -1 ){
        return;
    }
    
    fis.util.map(ret.src, function (subpath, file) {
        var content = file.getContent();
        if(file.isHtmlLike){
            var code = ['<script type="text/javascript" id="_testalert_" charset="utf-8" >',
                '!function(){',
                     "  _testalert_.parentNode.removeChild(_testalert_);",
                    'if(!new RegExp("'+ fis.util.escapeReg(config.urlReg) + '").test(location.href)){',
                        'return;',
                    '}',
                    'var _onload = function(){',
                        "var $msgEl = document.createElement('DIV');",
                        "$msgEl.innerHTML = '<img style=\"width:34px;vertical-align:-10px;\" src=" + skullIconBase64 + " />测试地址，请勿外传！'",
                        "var css = [",
                            "'height : 60px',",
                            "'line-height : 60px',",
                            "'width: 100%',",
                            "'position: absolute',",
                            "'top: 10px',",
                            "'left: 0',",
                            "'background: rgba(255,0,0,.8)',",
                            "'text-align: center',",
                            "'font-size: 20px',",
                            "'color: white',",
                            "'z-index: 999999999'",
                        "]",
                        "$msgEl.style.cssText = css.join(';');",
                        "document.body.appendChild($msgEl);",
                        "setTimeout( function(){",
                         "  $msgEl.parentNode.removeChild($msgEl);",
                        "},2000);",
                        "window.removeEventListener('load', _onload);",
                    "};",
                    "window.addEventListener('load', _onload, false);",
                "}();",
            "</script>"];
            code = code.join('\r\n');
            content = content.replace(/"(?:[^\\"\r\n\f]|\\[\s\S])*"|'(?:[^\\'\n\r\f]|\\[\s\S])*'|(<\/body>|<!--testalert-->)/ig, function(m, $1){
                if($1){
                    m = code + m;
                }
                return m;
            });
            file.setContent(content);
        }

    });
}
